{% extends 'base2.html' %}
{% load i18n %}
{% block extra_css %}
<style>
    .table-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #dee2e6;
      width: 100%;
    }

    .table-row span {
        flex: 1; /* Ensure the span elements take up equal space */
        text-align: center; /* Center align text for better readability */
    }

    .table-row:last-child {
      border-bottom: 0;
    }

    .table-row input {
        width: 100%; /* Ensure inputs take the full width */
    }

    .table-row .dropdown {
        flex: 0; /* Ensure the dropdown doesn't take up more space than necessary */
    }

    .table-button {
      white-space: nowrap;
    }

    /* This ensures buttons stay within the card */
    .card-footer > .row > .col, .card-footer > .row > .col-12 {
        padding: 0; /* Remove padding to allow buttons to fit */
    }
    /* Style for the toggle switch label */
    .toggle-label {
        margin-bottom: 0; /* Remove bottom margin from label */
        padding-top: 0.375rem; /* Align with the toggle switch */
    }
    .card-footer .btn, .card-footer .form-switch {
        margin-top: 10px; /* Add space between buttons when stacked */
    }

    .card-custom {
        background-color: white;
        border-radius: 10px;
        padding: 10px;
        width: 100%; /* Set to 100% to ensure it takes the full width in its container */
        margin-bottom: 10px;
        margin-right: 10px;
    }

    .progress {
        height: 10px;
        border-radius: 5px;
        background-color: #f0f0f0;
    }

    .progress-bar {
        background-color: green;
        transition: width 0.6s ease;
    }

    .profile-progress {
        display: flex;
        flex-wrap: wrap; 
        text-align: center;
    }

    .profile-details, .dropdown {
        flex: 1; /* Allow these items to take equal space */
        margin-bottom: 10px; /* Add space below these items on smaller screens */
    }

    .card-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .percentage-label {
        font-size: 16px;
        color: #333;
    }

    @media (min-width: 768px) {
        .card-custom {
            width: 48%; /* Set width to 48% to fit two cards per row with some gap */
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<nav aria-label="breadcrumb" class="mobile-margin-top">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'business-list' %}">{% translate "Businesses" %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ business.name | capfirst }}</li>
    </ol>
</nav>
<div class="rc-card">
    <div class="profile-progress">
        <div class="profile-details">
          <h1>{{ business.name | capfirst }}</h1>
          <p>{{ business.presentation }}</p>
          <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-cog"></i>
              </button>
              <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deleteBusinessModal">{% translate "Delete Business" %}</a></li>
              </ul>
          </div>
        </div>
    </div>
    <div class="profile-progress" style="justify-content: center;">
        <div class="card card-custom">
          <div class="card-body">
            <div class="card-title">
              <h5>{% translate "Business Status" %}</h5>
              <span class="percentage-label">{{ businesses_configuration.percentage_completed }}%</span>
            </div>
            <div class="progress my-3">
              <div class="progress-bar" role="progressbar" style="width: {{ businesses_configuration.percentage_completed }}%;" aria-valuenow="{{ businesses_configuration.percentage_completed }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <a href="#" data-bs-toggle="modal" data-bs-target="#actionsModal">{% translate "Actions" %}</a>
          </div>
        </div>
    </div>
</div>
<div class="modal fade" id="actionsModal" tabindex="-1" aria-labelledby="actionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionsModalLabel">{% translate "Business Actions" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_at_least_one_event %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">{% translate "Create one event" %}</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">{% translate "Create one event" %}</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_at_least_one_business_hour %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">{% translate "Business Hours" %}</span>
                    <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="{% translate "Customers will only be able to book any event on this business during the business hours declared below" %}"></i>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">{% translate "Business Hours" %}</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_business_presentation %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">{% translate "Filled Business Presentation" %}</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">{% translate "Filled Business Presentation" %}</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_header_image %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">{% translate "Web Header Image" %}</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">{% translate "Web Header Image" %}</span>
                {% endif %}
            </div>
        </div>
      </div>
    </div>
</div>

<div class="rc-card">
    <h1>{% translate "Events" %}</h1>
    <div class="container">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for event in events %}
            <div class="col">
                <div class="card h-100 mx-auto" style="border-radius: .75rem; box-shadow: 0 4px 8px rgba(0, 0, 0, .1);">
                    <div class="card-body" style="padding: 1.5rem; background: linear-gradient(to bottom right, #81E6D9, teal);">
                        <h5 class="card-title mb-2" style="font-size: 1.25rem; font-weight: 600; color: #4A5568;">{{ event.name }}</h5>
                        <p class="card-text" style="color: #718096;">{{ event.duration }} {% translate "mins" %}</p>
                        <a href="{% url 'event_detail' event.id %}" class="text-primary" style="color: #3182CE;">{% translate "View event page" %}</a>
                    </div>
                    <div class="card-footer" style="border-top: 1px solid #E2E8F0; background-color: transparent;">
                        <div class="row align-items-center">
                            <div class="col-5">
                                <a href="#" class="btn btn-outline-primary w-100 share-btn" data-bs-toggle="tooltip"
                                    data-appointment-url="{{domain}}{% url 'client_appointment_for_event' event.account.handler event.handler %}" 
                                    data-appointment-worker-url="{{domain}}{% url 'client_appointment_for_event_worker' event.account.handler event.handler user.customuser.id %}">
                                    {% translate "Share" %}
                                </a>
                            </div>
                            <div class="col-7">
                                <div class="form-check form-switch">
                                    <input class="form-check-input event-toggle" type="checkbox" id="toggleEvent{{ forloop.counter }}"
                                    data-event-id="{{ event.id }}" {% if event.active %}checked{% endif %}>
                                    <label class="form-check-label toggle-label" for="toggleEvent{{ forloop.counter }}" style="color: #4299E1;">
                                        {% if event.active %}
                                            {% translate "Turn Off" %}
                                        {% else %}
                                            {% translate "Turn On" %}
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="text-right mt-3">
        <a href="{% url 'add_business_event' business.id %}" class="btn btn-primary">{% translate "Add Event" %}</a>
    </div>
</div>

<div class="rc-card container-fluid">
    <div class="row">
        <!-- Business Hours Section -->
        <div class="col-md-6">
            <div class="rc-card">   
                <div class="row align-items-center"> <!-- Ensure vertical alignment in the middle -->
                    <div class="col-auto"> <!-- Use 'col-auto' to only take necessary width -->
                        <h2>{% translate "Business Hours" %}</h2>
                    </div>
                    <div class="col-auto"> <!-- Use 'col-auto' for the icon to stay close to the text -->
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="{% translate "Days declared here will be available in your events when customers book them" %}"></i>
                    </div>
                </div>
                <div class="container mt-5" id="businessHours">
                    {% for hour in business_hours %}
                    <div class="table-row hour-entry" data-hour-id="{{ hour.id }}" data-url="{% url 'business_hour_update' business.id hour.id %}">
                        <span class="weekday">{% translate hour.get_weekday_display %}</span>
                        <span class="from-hour">{{ hour.from_hour }}</span>
                        <span class="to-hour">{{ hour.to_hour }}</span>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item delete-hour" href="#">{% translate "Delete" %}</a></li>
                                <li><a class="dropdown-item edit-hour" href="#" data-bs-toggle="modal" data-bs-target="#editBusinessHourModal" data-hour-id="{{ hour.id }}" data-weekday="{{ hour.get_weekday_display }}" data-from-hour="{{ hour.from_hour }}" data-to-hour="{{ hour.to_hour }}">{% translate "Edit" %}</a></li>
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                    <button id="addHourButton" class="btn btn-primary mt-3">
                        <i class="fas fa-plus"></i> {% translate "Add New" %}
                    </button>
                    <div id="addHourForm" class="d-none mt-3">
                        <div class="table-row">
                            <select class="form-control" id="newWeekday">
                                {% for available_day in available_days %}
                                    <option value="{{available_day.0}}">{% translate available_day.1 %}</option>
                                {%endfor%}
                            </select>
                            <input type="time" id="newFromHour" class="form-control">
                            <input type="time" id="newToHour" class="form-control">
                        </div>
                        <button id="commitNewHour" class="btn btn-success mt-2">{% translate "Add" %}</button>
                        <button id="cancelNewHour" class="btn btn-danger mt-2">{% translate "Cancel" %}</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Days Closed or Holidays Section -->
        <div class="col-md-6">
            <div class="rc-card">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <h2>{% translate "Days Closed or Holidays" %}</h2>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="{% translate "Add special days you are closed. Maybe a bank holiday or something unexpected happened" %}"></i>
                    </div>
                </div>
                <div class="container mt-5" id="specialDays">        
                    {% for day in special_days %}
                        <div class="table-row special-day-entry" data-day-id="{{ day.id }}" data-url="{% url 'special_day_update_delete' business.id day.id %}">
                            <span class="date">{{ day.date }}</span>
                            <span class="from-hour">{{ day.from_hour }}</span>
                            <span class="to-hour">{{ day.to_hour }}</span>                
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.counter }}">
                                    <li><a class="dropdown-item delete-day" href="#">{% translate "Delete" %}</a></li>
                                    <li><a class="dropdown-item edit-day" href="#">{% translate "Edit" %}</a></li>
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                    <button id="addSpecialDayButton" class="btn btn-primary mt-3">
                        <i class="fas fa-plus"></i> {% translate "Add New" %}
                    </button>
                    <div id="addSpecialDayForm" class="d-none mt-3">
                        <div class="table-row">
                            <input type="date" id="newDate" class="form-control">
                            <input type="time" id="newDateFromHour" class="form-control">
                            <input type="time" id="newDateToHour" class="form-control">
                        </div>
                        <button id="commitNewSpecialDay" class="btn btn-success mt-2">{% translate "Add" %}</button>
                        <button id="cancelNewSpecialDay" class="btn btn-danger mt-2">{% translate "Cancel" %}</button>
                    </div>
                </div>
            </div>            
        </div>
    </div>
</div>
<div class="container-fluid rc-card">
    <div class="row">
        <div class="col-md-6">
            <div class="rc-card">
                <div class="row align-items-center"> <!-- Ensure vertical alignment in the middle -->
                    <div class="col-auto"> <!-- Use 'col-auto' to only take necessary width -->
                        <h2>{% translate "Workers" %}</h2>
                    </div>
                    <div class="col-auto"> <!-- Use 'col-auto' for the icon to stay close to the text -->
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="{% translate "Workers added here will be available to be assigned in your events" %}"></i>
                    </div>
                </div>

                <div class="container my-4">
                    <div class="table-responsive">
                        {% for worker in business.account_workers.all %}
                            <div class="table-row">
                                <span style="text-align:unset">{{worker.user.first_name|capfirst}} {{worker.user.last_name|capfirst}}</span>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                                            <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path>
                                        </svg>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                        <li><a class="dropdown-item" href="{% url 'worker_remove' business.id  worker.id %}">{% translate "Remove Worker" %}</a></li>
                                        <li><a class="dropdown-item" href="{% url 'worker_detail' business.id worker.id %}">{% translate "View Worker" %}</a></li>
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="d-flex">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteWorkerModal">{% translate "Add Worker" %}</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="rc-card card">
                <div class="row align-items-center"> <!-- Title row with icon -->
                    <div class="col-auto">
                        <h2>{% translate "Business Website" %}</h2>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="{% translate "Manage how your website looks" %}"></i>
                    </div>
                </div>
                    <div class="row">
                        <!-- Left column for visibility toggle and business description -->
                        <div class="col-md-6">
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_visible" {% if business_ui.is_visible %}checked{% endif %}>
                                    <label class="form-check-label" for="is_visible">{% translate "Is Visible" %}</label>
                                    <i class="fas fa-question-circle ms-2" onclick="showTooltip(this);" data-bs-toggle="tooltip" data-bs-placement="right" title="{% translate "Toggle to make your business website visible or invisible to customers." %}"></i>
                                </div>
                                <!-- Add Language Selector -->
                                <div class="mb-3">
                                    <label for="defaultLanguage" class="form-label">
                                        {% translate "Default Language" %}
                                        <i class="fas fa-question-circle" data-bs-toggle="tooltip" title="{% translate "Select the default language for your business." %}"></i>
                                    </label>
                                    <select class="form-control" id="defaultLanguage">
                                        {% for code, name in LANGUAGES %}
                                            <option value="{{ code }}" {% if business.default_language == code %}selected{% endif %}>
                                                {{ name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!-- Business Description -->
                                <div class="mb-3">
                                    <label for="businessDescription" class="form-label">
                                        {% translate "Business Description" %}
                                        <i class="fas fa-question-circle" data-bs-toggle="tooltip" title="{% translate "Provide a detailed description of your business." %}"></i>
                                    </label>
                                    <textarea class="form-control" id="businessDescription" rows="6
                                    " maxlength="500" placeholder="{% translate "Enter business description here..." %}">{{business_ui.description}}</textarea>
                                </div>
                                <div class="mb-3">
                                    <div class="form-label">
                                        <a href="{% url 'business_appearance' business_id=business.id %}">{% translate "Website Appearance" %}</a>
                                        <i class="fas fa-question-circle" data-bs-toggle="tooltip" title="{% translate "Set up your website appearance" %}"></i>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="event-link">
                                        <a href="{{web_url}}" class="info-link" id="businessWebsite" aria-disabled="false" target="_blank">
                                          {% translate "View Business Website" %}           
                                        </a>
                                        <i class="fas fa-info-circle ms-2" id="infoIcon"  data-bs-toggle="tooltip" data-bs-placement="right" title="{% translate "The more info you add to your business and events, the better the website will look" %}"></i>
                                      </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right column for business header image settings -->
                        <div class="col-md-6 d-flex flex-column align-items-center">
                            <div class="w-100 d-flex justify-content-center align-items-center text-center">
                                <h4 class="mb-2">{% translate "Header Image" %}</h4>
                                <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="{% translate "This image will show on the front header of this business website" %}"></i>
                            </div>
                            <img src="{{ business_ui.header_image_url }}" id="headerImagePreview" class="img-fluid mb-2" style="max-height: 200px;">
                            <!-- Button to open file picker -->
                            <button id="changeImageButton" class="btn btn-primary" style="width:50%;">{% translate "Change" %}</button>
                            <!-- Hidden File Input -->
                            <input type="file" id="businessHeaderImage" accept="image/png, image/jpeg" style="display:none;">
                        </div>
                    </div>
                    <!-- Row for Save and Cancel Buttons -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <button type="button" class="btn btn-primary" id="saveSettings">{% translate "Save Changes" %}</button>
                            <button type="button" class="btn btn-secondary" id="cancelSettings">{% translate "Cancel" %}</button>
                        </div>
                    </div>
            </div>
        </div>
        <div class="col-md-6">            
            <div class="rc-card">
                <h2>{% translate "Address Information" %}</h2>
                <div class="container form-container" id="addressForm">   
                    <div class="form-group mb-3">
                        <label for="address">{% translate "Address" %}:</label>
                        <input type="text" class="form-control" id="address" value="{{business.address.address}}" name="address" placeholder="{% translate "Enter address" %}">
                    </div>
                    <div class="form-group mb-3">
                        <label for="city">{% translate "City" %}:</label>
                        <input type="text" class="form-control" id="city" value="{{business.address.city}}" name="city" placeholder="{% translate "Enter city" %}">
                    </div>
                    <div class="form-group mb-3">
                        <label for="province">{% translate "Province" %}:</label>
                        <input type="text" class="form-control" id="province" value="{{business.address.province}}" name="province" placeholder="{% translate "Enter province" %}">
                    </div>
                    <div class="form-group mb-3">
                        <label for="country">{% translate "Country" %}:</label>
                        <input type="text" class="form-control" id="country" value="{{business.address.country}}" name="country" placeholder="{% translate "Enter country" %}">
                    </div>
                    <button type="button" class="btn btn-primary" id="saveAddressButton">{% translate "Save" %}</button>
                    <button type="button" class="btn btn-secondary" id="cancelAddressButton">{% translate "Cancel" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inviteWorkerModal" tabindex="-1" aria-labelledby="inviteWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteWorkerModalLabel">{% translate "Invite New Worker" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inviteWorkerForm">
                    <div class="mb-3">
                        <label for="recipientEmail" class="form-label">{% translate "Email address" %}</label>
                        <input type="email" class="form-control" id="recipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">{% translate "Recipient Name" %}</label>
                        <input type="text" class="form-control" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="invitationNotes" class="form-label">{% translate "Notes (optional)" %}</label>
                        <textarea class="form-control" id="invitationNotes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">{% translate "Send Invitation" %}</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Business Hour Modal -->
<div class="modal fade" id="editBusinessHourModal" tabindex="-1" aria-labelledby="editBusinessHourModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBusinessHourModalLabel">{% translate "Edit Business Hour" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editBusinessHourForm">
                    <div class="mb-3">
                        <label for="editWeekday" class="form-label">{% translate "Weekday" %}</label>
                        <select class="form-control" id="editWeekday">
                            {% for available_day in available_days %}
                                <option value="{{available_day.0}}">{{available_day.1}}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editFromHour" class="form-label">{% translate "From Hour" %}</label>
                        <input type="time" id="editFromHour" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editToHour" class="form-label">{% translate "To Hour" %}</label>
                        <input type="time" id="editToHour" class="form-control">
                    </div>
                    <button type="button" class="btn btn-primary" id="saveEditHour">{% translate "Save" %}</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Cancel" %}</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editSpecialDayModal" tabindex="-1" aria-labelledby="editSpecialDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSpecialDayModalLabel">{% translate "Edit Special Day" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSpecialDayForm">
                    <div class="mb-3">
                        <label for="editSpecialDayDate" class="form-label">{% translate "Date" %}</label>
                        <input type="date" id="editSpecialDayDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editSpecialDayFromHour" class="form-label">{% translate "From Hour" %}</label>
                        <input type="time" id="editSpecialDayFromHour" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editSpecialDayToHour" class="form-label">{% translate "To Hour" %}</label>
                        <input type="time" id="editSpecialDayToHour" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="saveEditSpecialDay">{% translate "Save changes" %}</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteBusinessModal" tabindex="-1" aria-labelledby="deleteBusinessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteBusinessModalLabel">{% translate "Confirm Business Deletion" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% translate "Are you sure you want to delete this business?" %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Cancel" %}</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBusiness">{% translate "Delete" %}</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="spinnerModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered justify-content-center" style="min-height:100vh;">
        <div class="modal-content" style="background-color: transparent; border: none; box-shadow: none;">
            <div class="modal-body d-flex align-items-center justify-content-center">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="sr-only">{% translate "Loading..." %}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareEventName" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shareEventName"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table">
            <tbody>
              <tr class="share-option clickable-row" style="text-align: center;" data-option="share-event">
                <td>{% translate "Share event" %}</td>
              </tr>
              <tr class="share-option clickable-row" style="text-align: center;" data-option="share-as-worker">
                <td>{% translate "Share with me as worker" %}</td>
              </tr>
              <tr class="share-option clickable-row" style="text-align: center;" data-option="cancel">
                <td>{% translate "Cancel" %}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
</div>


{% endblock %}

{% block extra_script %}
<script>
    available_week_days = []
    {% for day in available_days %}
        available_week_days.push({'id' : {{day.0}} , 'label' : '{{day.1}}' })
    {%endfor%}

    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip()
    })

    // Function to show tooltip when the help icon is clicked
    function showTooltip(icon) {
        $(icon).tooltip('show');
        // Hide the tooltip after some time automatically, optional
        setTimeout(function() { $(icon).tooltip('hide'); }, 2000);
    }

    function updateProgressBar(percentage) {
        $('.progress-bar').css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
        $('.percentage-label').text(percentage + '%');
    }
$(document).ready(function() {    

    // Delete hour endpoint base url. We need this when we remove an hour that was just added
    // NOTE: This url is hardcoded and if it changes in the server we have to change it here
    var deleteHourBaseUrl = 'business_hour/';

    let originalHeaderImage = $('#headerImagePreview').attr('src');
    let originalVisibility = $('#is_visible').is(':checked');

    var originalAddressData = {
        address: '{{business.address.address}}',
        city: '{{business.address.city}}',
        province: '{{business.address.province}}',
        country: '{{business.address.country}}'
    };

    $('#cancelAddressButton').click(function() {
        // Restore form values to the last saved state
        $('#addressForm input').each(function() {
            $(this).val(originalAddressData[this.name]);
        });
    });

    $('#saveAddressButton').click(function() {
        var formData = {
            address: $('#address').val(),
            city: $('#city').val(),
            province: $('#province').val(),
            country: $('#country').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'
        };

        $.post("{% url 'update_business_address' business.id %}", formData, function(response) {
            if (response.success) {
                alert('{% translate "Address information updated successfully!" %}');
                // Update originalData to the newly saved state
                originalAddressData = formData;
            } else {
                if (response.message) {
                    alert(response.message);
                } else {
                    alert('{% translate "Failed to update address information." %}');
                }
            }
        }).fail(function() {
            alert('{% translate "Error occurred while updating address information." %}');
        });
    });

    // Click event for 'Share' button
    $('.share-btn').click(function() {
        var appointmentUrl = $(this).data('appointment-url');
        var appointmentWorkerUrl = $(this).data('appointment-worker-url');
        var eventName = $(this).closest('.event-card').find('.card-title').text();
        $('#shareEventName').text(eventName);  // Set the event name in the modal
        $('#shareModal')
            .data('appointment-url', appointmentUrl)
            .data('appointment-worker-url', appointmentWorkerUrl)
            .modal('show');  // Store event ID and business ID and show the modal
    });

    // Click events for modal options
    $('.share-option').click(function() {
        var option = $(this).data('option');
        var appointmentUrl = $('#shareModal').data('appointment-url');
        var appointmentWorkerUrl = $('#shareModal').data('appointment-worker-url');
        var button = $(this).closest('.modal-content').find('.share-btn'); 

        // Handle each option click
        var fullUrl = '';
        if(option === 'share-event') {
            fullUrl = appointmentUrl;
        } else if(option === 'share-as-worker') {
            fullUrl = appointmentWorkerUrl;
        } else if(option === 'cancel') {
            $('#shareModal').modal('hide');
        }

        if (fullUrl) {
            // Copy the URL to clipboard
            navigator.clipboard.writeText(fullUrl).then(function() {
                button.attr('title', 'URL copied to clipboard!').tooltip('show');

                // Set timeout to hide tooltip after 2 seconds
                setTimeout(function() {
                    button.tooltip('hide');
                }, 4000);

            }).catch(function(err) {
                button.attr('title', 'Failed to copy URL.').tooltip('show');

                // Set timeout to hide tooltip after 4 seconds
                setTimeout(function() {
                    button.tooltip('hide');
                }, 4000);
                console.error('Could not copy text: ', err);
            });
        }        

        // Close the modal after selection
        $('#shareModal').modal('hide');
    });

    // Ensure tooltips are initialized
    $('[data-bs-toggle="tooltip"]').tooltip();

    $('#businessHeaderImage').change(function(e) {
        if (e.target.files[0].size > 512000) { // 0.5Mb
            alert('{% translate "File size exceeds 0.5MB. Please upload a smaller file." %}');
            return;
        }

        if (e.target.files && e.target.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                $('#headerImagePreview').attr('src', e.target.result);
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    $('#changeImageButton').click(function() {
        // Trigger the file input when the 'Change' button is clicked
        $('#businessHeaderImage').click();
    });

    $('#saveSettings').click(function() {
        saveBusinessUI()
    })

    function showSpinner() {
        $('#spinnerModal').modal({
            backdrop: 'static', // Disable clicking on the backdrop to close
            keyboard: false // Disable using the keyboard to close
        }).modal('show');
    }

    function hideSpinner() {
        $('#spinnerModal').modal('hide');
    }

    $('#cancelSettings').click(function() {
        $('#headerImagePreview').attr('src', originalHeaderImage);
        $('#is_visible').prop('checked', originalVisibility);

        // Clear the file input
        $('#businessHeaderImage').val(null);
    });

    function saveBusinessUI() {
        // Collect data from all editable fields
        var formData = new FormData();
        formData.append('description', $('#businessDescription').val());
        formData.append('is_visible', $('#is_visible').is(':checked'));
        formData.append('business_header_image', $('#businessHeaderImage')[0].files[0]);
        formData.append('default_language', $('#defaultLanguage').val());
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        $.ajax({
            url: '{% url "update_business_ui" business.id %}',
            type: 'POST',
            data: formData,
            processData: false,  // Important: tells jQuery not to process the data
            contentType: false,  // Important: tells jQuery not to set contentType
            success: function(response) {
                if (response.success) {
                    console.log('{% translate "Business UI details updated successfully" %}');
                    // Keep the last saved values
                    originalImage = $('#headerImagePreview').attr('src');
                    originalVisibility = $('#is_visible').is(':checked');
                } else {
                    if (response.message) {
                        alert(response.message); // Display server-side error message
                    } else {
                        alert('{% translate "Error updating business details. Please try again." %}');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('{% translate "Error updating business details:" %}', error);
            }
        });
    }

    $('.event-toggle').change(function() {
        var checked = $(this).is(':checked');
        var eventId = $(this).data('event-id');  // Assuming you add a data-event-id attribute to your inputs
        var label = $(this).next('.toggle-label');
        label.text(checked ? '{% translate "Turn Off" %}' : '{% translate "Turn On" %}');

        // Post the change to the server
        $.ajax({
            url: '/update-event-status/',  // URL to your Django view
            type: 'POST',
            data: {
                'event_id': eventId,
                'active': checked,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('{% translate "Update successful" %}');
            },
            error: function(xhr, status, error) {
                console.error('{% translate "Error updating event status:" %}', error);
            }
        });
    });

    $('#confirmDeleteBusiness').click(function() {
        $.ajax({
            url: '{% url "delete_business" business.id %}',
            type: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function() {
                alert('{% translate "Business deleted successfully!" %}');
                window.location.href = '{% url "dashboard" %}';
            },
            error: function(xhr) {
                var errorMessage = '{% translate "Failed to delete the business. Contact system admins or try again later" %}';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            }
        });
    });

    // Open edit modal and populate with current data
    $(document).on('click', '.edit-hour', function() {
        var hourId = $(this).data('hour-id');
        var weekday = $(this).data('weekday');
        var fromHour = $(this).data('from-hour');
        var toHour = $(this).data('to-hour');

        $('#editBusinessHourModal').data('hour-id', hourId);
        $('#editWeekday').val(weekday);
        $('#editFromHour').val(fromHour);
        $('#editToHour').val(toHour);
    });

    // Save changes from the modal
    $('#saveEditHour').click(function() {
        var hourId = $('#editBusinessHourModal').data('hour-id');
        var weekday = $('#editWeekday').val();
        var fromHour = $('#editFromHour').val();
        var toHour = $('#editToHour').val();
        var url = $(`.hour-entry[data-hour-id="${hourId}"]`).data('url');

        $.post(url, {
            weekday: weekday,
            from_hour: fromHour,
            to_hour: toHour,
            account_id: {{business.id}},
            csrfmiddlewaretoken: '{{ csrf_token }}',
        }, function(response) {
            if (response.success) {
                // Update the display
                var $row = $(`.hour-entry[data-hour-id="${hourId}"]`);
                var weekday_label = weekday;
                for (var i = 0; i < available_week_days.length; i++) {
                    if (available_week_days[i]["id"] == weekday) {
                        weekday_label = available_week_days[i]["label"];
                    }
                }
                $row.find('.weekday').text(weekday_label);
                $row.find('.from-hour').text(fromHour);
                $row.find('.to-hour').text(toHour);

                // Close the modal
                $('#editBusinessHourModal').modal('hide');
            } else {
                alert('{% translate "Error updating the business hour." %}');
            }
        });
    });

    // Add new business hour
    $("#addHourButton").click(function() {
        $("#addHourForm").removeClass('d-none');
        $(this).addClass('d-none');
    });

    // Cancel new hour
    $("#cancelNewHour").click(function() {
        $("#addHourForm").addClass('d-none');
        $("#addHourButton").removeClass('d-none');
        // Reset form values
        $("#newWeekday").val('');
        $("#newFromHour").val('');
        $("#newToHour").val('');
    });

    $("#commitNewHour").click(function() {
        var newDate = $("#newWeekday").val();
        var newFromHour = $("#newFromHour").val();
        var newToHour = $("#newToHour").val();

        // Post the new hours to the server
        $.post("{% url 'business_hour_create' business.id %}", {
            weekday: newDate,
            from_hour: newFromHour,
            to_hour: newToHour,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            // Add any other required data
        }, function(response) {
            if (response.success) {
                var weekdayText = $("#newWeekday option:selected").text();
                var newHourHtml = `
                <div class="table-row hour-entry" data-hour-id="${response.hour_id}" data-url="/${deleteHourBaseUrl}{{business.id}}/${response['hour_id']}">
                    <span class="weekday">${weekdayText}</span>
                    <span class="from-hour">${newFromHour}</span>
                    <span class="to-hour">${newToHour}</span>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item delete-hour" href="#">{% translate "Delete" %}</a></li>
                            <li><a class="dropdown-item edit-hour" href="#">{% translate "Edit" %}</a></li>
                        </ul>
                    </div>
                    <div class="edit-actions d-none">
                        <button class="btn btn-success commit-hour-edit">{% translate "Save" %}</button>
                        <button class="btn btn-danger cancel-hour-edit">{% translate "Cancel" %}</button>
                    </div>
                </div>`;
                
                // Append the new entry to the business hours list
                $("#addHourButton").before(newHourHtml);
                
                // Reset the form and hide it
                $("#addHourForm").addClass('d-none');
                $("#addHourButton").removeClass('d-none');
                $("#newWeekday").val('');
                $("#newFromHour").val('');
                $("#newToHour").val('');
            } else {
                // Handle errors, such as displaying a message to the user
                alert('{% translate "Error saving the new special day." %}');
            }
        });
    });

    // Event handler for Delete hour action
    $(document).on('click', '.delete-hour', function(e) {
        e.preventDefault(); // Prevent default action of the anchor tag

        var $row = $(this).closest('.hour-entry'); // Get the closest hour entry row
        var hourId = $row.data('hour-id'); // Assume each hour entry has a data-hour-id attribute
        var url = $row.data('url');
        console.log('hourId: ' + hourId)

        // Show confirmation dialog
        var confirmDelete = confirm('{% translate "Are you sure you want to delete this business hour?" %}');
        if (confirmDelete) {
            // User confirmed deletion
            $.ajax({
                url: url,
                method: 'DELETE', // Specifying the method as DELETE
                data: {
                    account_id: {{business.id}}
                    // Include any other necessary data
                },
                headers: {
                    'X-CSRFToken': '{{csrf_token}}' // Include the CSRF token in the request header
                },
                success: function(response) {
                    if (response.success) {
                        // Successfully deleted on the server, now remove the row
                        $row.remove();
                        alert('{% translate "Business hour deleted successfully." %}');
                    } else {
                        // Handle failure
                        alert('{% translate "Error: Could not delete the business hour." %}');
                    }
                },
                error: function() {
                    // Handle AJAX failure
                    alert('{% translate "Error communicating with the server." %}');
                }
            });
        } else {
            // User canceled deletion
            console.log("{% translate "Deletion canceled." %}");
        }
    });

    $("#addSpecialDayButton").click(function() {
        $(this).addClass('d-none'); // Hide "Add New" button
        $("#addSpecialDayForm").removeClass('d-none'); // Show inputs and buttons
    });

    $("#cancelNewSpecialDay").click(function() {
        $("#addSpecialDayForm").addClass('d-none'); // Hide form
        $("#addSpecialDayButton").removeClass('d-none'); // Show "Add New" button
        // Reset inputs
        $("#newDate").val('');
        $("#newDateFromHour").val('');
        $("#newDateToHour").val('');
    });

    $("#commitNewSpecialDay").click(function() {
        var newDate = $("#newDate").val();
        var newDateFromHour = $("#newDateFromHour").val();
        var newDateToHour = $("#newDateToHour").val();

        // Post the new hours to the server
        $.post('{% url "special_day_create" business.id %}', {
            date: newDate,
            from_hour: newDateFromHour,
            to_hour: newDateToHour,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if (response.success) {
                // Dynamically create and insert the new special day entry above the "Add New" button
                var newSpecialDayHtml = `<div class="table-row special-day-entry" data-day-id="${response.id}">
                    <span class="date">${newDate}</span>
                    <span class="from-hour">${newDateFromHour}</span>
                    <span class="to-hour">${newDateToHour}</span>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item delete-day" href="#">{% translate "Delete" %}</a></li>
                            <li><a class="dropdown-item edit-day" href="#">{% translate "Edit" %}</a></li>
                        </ul>
                    </div>
                    <div class="edit-actions d-none">
                        <button class="btn btn-success commit-edit">{% translate "Save" %}</button>
                        <button class="btn btn-danger cancel-edit">{% translate "Cancel" %}</button>
                    </div>
                </div>`;

                // Insert the new entry above the "Add New" button
                $("#addSpecialDayButton").before(newSpecialDayHtml);

                // Hide the form and reset form inputs
                $("#addSpecialDayForm").addClass('d-none');
                $("#addSpecialDayButton").removeClass('d-none');
                $("#newDate").val('');
                $("#newDateFromHour").val('');
                $("#newDateToHour").val('');
            } else {
                // Handle errors, such as displaying a message to the user
                alert('{% translate "Error saving the new special day." %}');
            }
        }).fail(function() {
            alert('{% translate "Error communicating with the server." %}');
        })
    });

    // Function to make a day entry editable
    function makeEditable($row) {
        var currentDate = $row.find('.date').text().trim();
        var currentFromHour = $row.find('.from-hour').text().trim();
        var currentToHour = $row.find('.to-hour').text().trim();

        $row.data('original-date', currentDate);
        $row.data('original-from-hour', currentFromHour);
        $row.data('original-to-hour', currentToHour);

        $row.find('.date').html(`<input type="date" value="${currentDate}" class="form-control">`);
        $row.find('.from-hour').html(`<input type="time" value="${currentFromHour}" class="form-control">`);
        $row.find('.to-hour').html(`<input type="time" value="${currentToHour}" class="form-control">`);
        $row.find('.edit-actions').removeClass('d-none');
        $row.find('.dropdown').addClass('d-none');
    }

    // Delete Action
    $(".delete-day").click(function(e) {
        e.preventDefault();
        var $row = $(this).closest('.special-day-entry');
        var dayId = $row.data('day-id');
        var url = $row.data('url');

        // Show confirmation dialog
        var confirmDelete = confirm('{% translate "Are you sure you want to delete this day with special hours?" %}');
        if (confirmDelete) {
            // User confirmed deletion
            $.ajax({
                url: url,
                method: 'DELETE', 
                data: {
                    account_id: {{business.id}}
                },
                headers: {
                    'X-CSRFToken': '{{csrf_token}}' // Include the CSRF token in the request header
                },
                success: function(response) {
                    if (response.success) {
                        // Successfully deleted on the server, now remove the row
                        $row.remove();
                        alert('{% translate "Special day deleted successfully." %}');
                    } else {
                        // Handle failure
                        alert('{% translate "Error: Could not delete the special day." %}');
                    }
                },
                error: function() {
                    // Handle AJAX failure
                    alert('{% translate "Error communicating with the server." %}');
                }
            });
        } else {
            // User canceled deletion
            console.log("{% translate "Deletion canceled." %}");
        }
    });

    $(document).on('click', '.edit-day', function() {
        var $row = $(this).closest('.special-day-entry');
        var dayId = $row.data('day-id');
        var date = $row.find('.date').text().trim();
        var fromHour = $row.find('.from-hour').text().trim();
        var toHour = $row.find('.to-hour').text().trim();
        
        $('#editSpecialDayDate').val(date);
        $('#editSpecialDayFromHour').val(fromHour);
        $('#editSpecialDayToHour').val(toHour);
        $('#editSpecialDayModal').data('day-id', dayId).modal('show');
    });

    // Save the changes
    $('#saveEditSpecialDay').click(function() {
        var dayId = $('#editSpecialDayModal').data('day-id');
        var date = $('#editSpecialDayDate').val();
        var fromHour = $('#editSpecialDayFromHour').val();
        var toHour = $('#editSpecialDayToHour').val();
        var $row = $('.special-day-entry[data-day-id="' + dayId + '"]');
        var url = $row.data('url');
        
        $.post(url, {
            date: date,
            from_hour: fromHour,
            to_hour: toHour,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if (response.success) {
                $row.find('.date').text(date);
                $row.find('.from-hour').text(fromHour);
                $row.find('.to-hour').text(toHour);
                $('#editSpecialDayModal').modal('hide');
            } else {
                alert('{% translate "Error updating the special day." %}');
            }
        });
    });

    $(".cancel-edit").click(function() {
        var $row = $(this).closest('.special-day-entry');
        // Retrieve the original text values stored in the jQuery data
        var originalDate = $row.data('original-date');
        var originalFromHour = $row.data('original-from-hour');
        var originalToHour = $row.data('original-to-hour');

        // Update the HTML of the date, from-hour, and to-hour spans to show the original text
        $row.find('.date').html(`<span>${originalDate}</span>`);
        $row.find('.from-hour').html(`<span>${originalFromHour}</span>`);
        $row.find('.to-hour').html(`<span>${originalToHour}</span>`);

        // Hide the edit actions (save and cancel buttons) and show the dropdown again
        $row.find('.edit-actions').addClass('d-none');
        $row.find('.dropdown').removeClass('d-none');
    });

    $('#inviteWorkerForm').submit(function(e) {
        e.preventDefault();  // Prevent the default form submission behavior

        // Collecting the form data
        var recipientEmail = $('#recipientEmail').val();
        var recipientName = $('#recipientName').val();
        var invitationNotes = $('#invitationNotes').val();
        showSpinner()
        $.ajax({
            url: '{% url "send_business_invitation" %}',
            type: 'POST',
            data: {
                recipient_email: recipientEmail,
                recipient_name: recipientName,
                notes: invitationNotes,
                business_id: '{{ business.id }}',
            },
            headers: {
                'X-CSRFToken': '{{csrf_token}}' 
            },
            success: function(response) {
                // Handle the successful response
                hideSpinner();
                alert(response['message']);
                $('#inviteWorkerModal').modal('hide');
            },
            error: function() {
                // Handle any error
                hideSpinner();
                alert('{% translate "Error sending invitation" %}');
            },
            complete: function() {
                hideSpinner();  
            }
        });
    });

});    
</script>

{% endblock extra_script %}


