{% extends 'base2.html' %}

{% block extra_css %}
<style>
    .table-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #dee2e6;
    }

    .table-row:last-child {
      border-bottom: 0;
    }

    .table-button {
      white-space: nowrap;
    }

    /* This ensures buttons stay within the card */
    .card-footer > .row > .col, .card-footer > .row > .col-12 {
        padding: 0; /* Remove padding to allow buttons to fit */
    }
    /* Style for the toggle switch label */
    .toggle-label {
        margin-bottom: 0; /* Remove bottom margin from label */
        padding-top: 0.375rem; /* Align with the toggle switch */
    }
    .card-footer .btn, .card-footer .form-switch {
        margin-top: 10px; /* Add space between buttons when stacked */
    }

    .card-custom {
        background-color: white;
        border-radius: 10px;
        padding: 10px;
        width: 300px; /* Fixed width for the progress bar card */
    }

    .progress {
        height: 10px;
        border-radius: 5px;
        background-color: #f0f0f0;
    }

    .progress-bar {
        background-color: green;
        transition: width 0.6s ease;
    }

    /* Custom Styling for Responsive Adjustments */
    .profile-progress {
        display: flex;
        flex-direction: column; /* Stack vertically by default */
        align-items: flex-start; /* Align items at the start */
    }

    .profile-details {
        width: 100%; /* Ensure it fills the container */
    }

    @media (min-width: 768px) {
        .profile-progress {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        }

        .profile-details {
        margin-right: 20px; /* Space between text and progress bar */
        }
    }

    .card-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .percentage-label {
        font-size: 16px;
        color: #333;
    }

  </style>
{% endblock extra_css %}

{% block content %}
<nav aria-label="breadcrumb" class="mobile-margin-top">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'business-list' %}">Businesses</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ business.name | capfirst }}</li>
    </ol>
</nav>
<div class="rc-card">
    <div class="profile-progress">
        <div class="profile-details">
          <h1>{{ business.name | capfirst }}</h1>
          <p>{{ business.presentation }}</p>
        </div>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deleteBusinessModal">Delete Business</a></li>
            </ul>
        </div>
        <div class="card card-custom" style="margin: 5px;">
          <div class="card-body">
            <div class="card-title">
              <h5>Business Status</h5>
              <span class="percentage-label">{{ businesses_configuration.percentage_completed }}%</span>
            </div>
            <div class="progress my-3">
              <div class="progress-bar" role="progressbar" style="width: {{ businesses_configuration.percentage_completed }}%;" aria-valuenow="{{ businesses_configuration.percentage_completed }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <a href="#" data-bs-toggle="modal" data-bs-target="#actionsModal">Actions</a>
          </div>
        </div>
        <div class="card card-custom" style="margin: 5px;">
            <div class="card-body">
              <div class="card-title">
                <h5>Business Website</h5>
              </div>
              <div class="event-link text-center">
                <a href="{{web_url}}" class="info-link" id="businessWebsite" aria-disabled="false" target="_blank">
                  View Business Website           
                </a>
                <i class="fas fa-info-circle ms-2" id="infoIcon"  data-bs-toggle="tooltip" data-bs-placement="right" title="The more info you add to your business and events, the better the website will look"></i>
              </div>
            </div>
          </div>
    </div>
</div>
<div class="modal fade" id="actionsModal" tabindex="-1" aria-labelledby="actionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionsModalLabel">Business Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_at_least_one_event %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">Create one event</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">Create one event</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_at_least_one_business_hour %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">Worked on Business Hours</span>
                    <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="Customers will only be able to book any event on this business during the business hours declared below"></i>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">Worked on Business Hours</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_business_description %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">Filled Business Description</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">Filled Business Description</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if businesses_configuration.has_header_image %} 
                    <i class="fas fa-check-circle fa-sm text-success"></i>
                    <span class="ms-2 text-muted">Added a Front Image</span>
                {% else %}
                    <i class="far fa-circle fa-sm text-danger"></i>
                    <span class="ms-2 text-muted">Added a Front Image</span>
                {% endif %}
            </div>
        </div>
      </div>
    </div>
</div>

<div class="rc-card">
    <h1>Events</h1>
    <div class="container">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for event in events %}
            <div class="col">
                <div class="card h-100 mx-auto" style="border-radius: .75rem; box-shadow: 0 4px 8px rgba(0, 0, 0, .1);">
                    <div class="card-body" style="padding: 1.5rem; background: linear-gradient(to bottom right, #81E6D9, #C6F6D5);">
                        <h5 class="card-title mb-2" style="font-size: 1.25rem; font-weight: 600; color: #4A5568;">{{ event.name }}</h5>
                        <p class="card-text" style="color: #718096;">{{ event.duration }} mins</p>
                        <a href="{% url 'event_detail' event.id %}" class="text-primary" style="color: #3182CE;">View event page</a>
                    </div>
                    <div class="card-footer" style="border-top: 1px solid #E2E8F0; background-color: transparent;">
                        <div class="row align-items-center">
                            <div class="col-5">
                                <a href="#" class="btn btn-outline-primary w-100 shareButton"  data-share-url="{{ event.event_url }}">Share</a>
                            </div>
                            <div class="col-7">
                                <div class="form-check form-switch">
                                    <input class="form-check-input event-toggle" type="checkbox" id="toggleEvent{{ forloop.counter }}"
                                    data-event-id="{{ event.id }}" {% if event.active %}checked{% endif %}>
                                    <label class="form-check-label toggle-label" for="toggleEvent{{ forloop.counter }}" style="color: #4299E1;">
                                        {% if event.active %}
                                            Turn Off
                                        {% else %}
                                            Turn On
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="text-right mt-3">
        <a href="{% url 'add_business_event' business.id %}" class="btn btn-primary">Add Event</a>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <!-- Business Hours Section -->
        <div class="col-md-6">
            <div class="rc-card">   
                <div class="row align-items-center"> <!-- Ensure vertical alignment in the middle -->
                    <div class="col-auto"> <!-- Use 'col-auto' to only take necessary width -->
                        <h2>Business Hours</h2>
                    </div>
                    <div class="col-auto"> <!-- Use 'col-auto' for the icon to stay close to the text -->
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="Days declared here will be available in your events when customers book them"></i>
                    </div>
                </div>
                <div class="container mt-5" id="businessHours">
                    {% for hour in business_hours %}
                    <div class="table-row hour-entry" data-hour-id="{{ hour.id }}" data-url="{% url 'business_hour_update' business.id hour.id %}">
                        <span class="weekday">{{ hour.get_weekday_display }}</span>
                        <span class="from-hour">{{ hour.from_hour }}</span>
                        <span class="to-hour">{{ hour.to_hour }}</span>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item delete-hour" href="#">Delete</a></li>
                                <li><a class="dropdown-item edit-hour" href="#">Edit</a></li>
                            </ul>
                        </div>
                        <div class="edit-actions d-none">
                            <button class="btn btn-success commit-hour-edit">Save</button>
                            <button class="btn btn-danger cancel-hour-edit">Cancel</button>
                        </div>
                    </div>
                    {% endfor %}
                    <button id="addHourButton" class="btn btn-primary mt-3">
                        <i class="fas fa-plus"></i> Add New
                    </button>
                    <div id="addHourForm" class="d-none mt-3">
                        <div class="table-row">
                            <select class="form-control" id="newWeekday">
                                {% for available_day in available_days %}
                                    <option value="{{available_day.0}}">{{available_day.1}}</option>
                                {%endfor%}
                            </select>
                            <input type="time" id="newFromHour" class="form-control">
                            <input type="time" id="newToHour" class="form-control">
                        </div>
                        <button id="commitNewHour" class="btn btn-success mt-2">Commit</button>
                        <button id="cancelNewHour" class="btn btn-danger mt-2">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Days Closed or Holidays Section -->
        <div class="col-md-6">
            <div class="rc-card">
                <div class="row align-items-center"> <!-- Ensure vertical alignment in the middle -->
                    <div class="col-auto"> <!-- Use 'col-auto' to only take necessary width -->
                        <h2>Days Closed or Holidays</h2>
                    </div>
                    <div class="col-auto"> <!-- Use 'col-auto' for the icon to stay close to the text -->
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="Add special days you are closed. Maybe a bank holiday or something unexpected happened"></i>
                    </div>
                </div>
                <div class="container mt-5" id="specialDays">        
                    {% for day in special_days %}
                        <div class="table-row special-day-entry" data-day-id="{{ day.id }}" data-url="{% url 'special_day_update_delete' business.id day.id %}">
                            <span class="date">{{ day.date }}</span> <!-- Added class="date" -->
                            <span class="from-hour">{{ day.from_hour }}</span> <!-- Added class="from-hour" -->
                            <span class="to-hour">{{ day.to_hour }}</span> <!-- Added class="to-hour" -->                
                            <!-- Dropdown Button -->
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.counter }}">
                                    <li><a class="dropdown-item delete-day" href="#">Delete</a></li>
                                    <li><a class="dropdown-item edit-day" href="#">Edit</a></li>
                                </ul>
                            </div>
                            <!-- Edit and Delete Actions -->
                            <div class="edit-actions d-none">
                                <button class="btn btn-success commit-edit">Save</button>
                                <button class="btn btn-danger cancel-edit">Cancel</button>
                            </div>
                        </div>
                    {% endfor %}
                    <button id="addSpecialDayButton" class="btn btn-primary mt-3">
                        <i class="fas fa-plus"></i> Add New
                    </button>
                    <div id="addSpecialDayForm" class="d-none mt-3">
                        <div class="table-row">
                            <input type="date" id="newDate" class="form-control">
                            <input type="time" id="newDateFromHour" class="form-control">
                            <input type="time" id="newDateToHour" class="form-control">
                        </div>
                        <button id="commitNewSpecialDay" class="btn btn-success mt-2">Commit</button>
                        <button id="cancelNewSpecialDay" class="btn btn-danger mt-2">Cancel</button>
                    </div>
                </div>
            </div>   
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div class="rc-card">
                <div class="row align-items-center"> <!-- Ensure vertical alignment in the middle -->
                    <div class="col-auto"> <!-- Use 'col-auto' to only take necessary width -->
                        <h2>Workers</h2>
                    </div>
                    <div class="col-auto"> <!-- Use 'col-auto' for the icon to stay close to the text -->
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="Workers added here will be available to be assigned in your events"></i>
                    </div>
                </div>

                <div class="container my-4">
                    <div class="table-responsive">
                        {% for worker in business.account_workers.all %}
                            <div class="table-row">
                                <span>{{worker.user.first_name}} {{worker.user.last_name}}</span>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                                            <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path>
                                        </svg>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                        <li><a class="dropdown-item" href="{% url 'worker_remove' business.id  worker.id %}">Remove Worker</a></li>
                                        <li><a class="dropdown-item" href="{% url 'worker_detail' business.id worker.id %}">View Worker</a></li>
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteWorkerModal">Add Worker</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="rc-card card">
                <div class="row align-items-center"> <!-- Title row with icon -->
                    <div class="col-auto">
                        <h2>Website Settings</h2>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-info-circle ms-2" id="infoIcon" data-bs-toggle="tooltip" 
                        data-bs-placement="right" title="Manage how your website looks"></i>
                    </div>
                </div>
                <div class="container mt-5">
                    <div class="row">
                        <!-- Left column for visibility toggle and business description -->
                        <div class="col-md-6">
                            <div class="card-body">
                                <!-- Toggle Visibility -->
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_visible" {% if business_ui.is_visible %}checked{% endif %}>
                                    <label class="form-check-label" for="is_visible">Is Visible</label>
                                    <i class="fas fa-question-circle ms-2" onclick="showTooltip(this);" data-bs-toggle="tooltip" data-bs-placement="right" title="Toggle to make your business website visible or invisible to customers."></i>
                                </div>
                                <!-- Business Description -->
                                <div class="mb-3">
                                    <label for="businessDescription" class="form-label">
                                        Business Description
                                        <i class="fas fa-question-circle" data-bs-toggle="tooltip" title="Provide a detailed description of your business."></i>
                                    </label>
                                    <textarea class="form-control" id="businessDescription" rows="3" maxlength="500" placeholder="Enter business description here...">{{business_ui.description}}</textarea>
                                </div>
                                <div class="mb-3">
                                    <div class="form-label">
                                        <a href="{% url 'business_appearance' business_id=business.id %}">Website Appearance</a>
                                        <i class="fas fa-question-circle" data-bs-toggle="tooltip" title="Set up your website aooearance"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right column for business header image settings -->
                        <div class="col-md-6 d-flex flex-column align-items-center">
                            <div class="w-100 d-flex justify-content-center align-items-center">
                                <h4 class="mb-2">Business Header Image</h4>
                                <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="This image will show on the front header of this business website"></i>
                            </div>
                            <img src="{{ business_ui.header_image.url|default:'/media/businesses/placeholder.jpg' }}" id="headerImagePreview" class="img-fluid mb-2" style="max-height: 200px;">
                            <!-- Button to open file picker -->
                            <button id="changeImageButton" class="btn btn-primary" style="width:50%;">Change</button>
                            <!-- Hidden File Input -->
                            <input type="file" id="businessHeaderImage" accept="image/png, image/jpeg" style="display:none;">
                        </div>
                    </div>
                    <!-- Row for Save and Cancel Buttons -->
                    <div class="row mt-4">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-primary" id="saveSettings">Save Changes</button>
                            <button type="button" class="btn btn-secondary" id="cancelSettings">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inviteWorkerModal" tabindex="-1" aria-labelledby="inviteWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteWorkerModalLabel">Invite New Worker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inviteWorkerForm">
                    <div class="mb-3">
                        <label for="recipientEmail" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="recipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">Recipient Name</label>
                        <input type="text" class="form-control" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="invitationNotes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="invitationNotes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteBusinessModal" tabindex="-1" aria-labelledby="deleteBusinessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteBusinessModalLabel">Confirm Business Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this business?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBusiness">Delete</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="spinnerModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered justify-content-center" style="min-height:100vh;">
        <div class="modal-content" style="background-color: transparent; border: none; box-shadow: none;">
            <div class="modal-body d-flex align-items-center justify-content-center">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
    available_week_days = []
    {% for day in available_days %}
        available_week_days.push({'id' : {{day.0}} , 'label' : '{{day.1}}' })
    {%endfor%}

    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip()
    })

    // Function to show tooltip when the help icon is clicked
    function showTooltip(icon) {
        $(icon).tooltip('show');
        // Hide the tooltip after some time automatically, optional
        setTimeout(function() { $(icon).tooltip('hide'); }, 2000);
    }

    function updateProgressBar(percentage) {
        $('.progress-bar').css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
        $('.percentage-label').text(percentage + '%');
    }



$(document).ready(function() {    

    // Delete hour endpoint base url. We need this when we remove an hour that was just added
    // NOTE: This url is hardcoded and if it changes in the server we have to change it here
    var deleteHourBaseUrl = 'business_hour/';

    let originalHeaderImage = $('#headerImagePreview').attr('src');
    let originalVisibility = $('#is_visible').is(':checked');

    $('.shareButton').click(function(e) {
        e.preventDefault(); // Prevent the default anchor behavior
        var shareUrl = $(this).data('share-url'); // Get the URL to be copied

        navigator.clipboard.writeText(shareUrl).then(function() {
            // On successful copying to clipboard
            console.log('Link successfully copied to clipboard');

            // Show tooltip
            $(e.target).tooltip({
                title: "Link copied!",
                placement: "top",
                trigger: "manual"
            }).tooltip('show');

            // Hide tooltip after 1 second
            setTimeout(function() {
                $(e.target).tooltip('hide');
            }, 1000);
        }).catch(function(error) {
            // On failure to copy
            console.error('Error copying link to clipboard: ', error);
        });
    });

    // Ensure tooltips are initialized
    $('[data-bs-toggle="tooltip"]').tooltip();

    $('#businessHeaderImage').change(function(e) {
        if (e.target.files && e.target.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                $('#headerImagePreview').attr('src', e.target.result);
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    $('#changeImageButton').click(function() {
        // Trigger the file input when the 'Change' button is clicked
        $('#businessHeaderImage').click();
    });

    $('#saveSettings').click(function() {
        saveBusinessUI()
    })

    function showSpinner() {
        $('#spinnerModal').modal({
            backdrop: 'static', // Disable clicking on the backdrop to close
            keyboard: false // Disable using the keyboard to close
        }).modal('show');
    }

    function hideSpinner() {
        $('#spinnerModal').modal('hide');
    }

    $('#cancelSettings').click(function() {
        $('#headerImagePreview').attr('src', originalHeaderImage);
        $('#is_visible').prop('checked', originalVisibility);

        // Clear the file input
        $('#businessHeaderImage').val(null); 
    });

    function saveBusinessUI() {
        // Collect data from all editable fields
        var formData = new FormData();
        formData.append('description', $('#businessDescription').val());
        formData.append('is_visible', $('#is_visible').is(':checked'));
        formData.append('business_header_image', $('#businessHeaderImage')[0].files[0]); 
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); 

        $.ajax({
            url: '{% url "update_business_ui" business.id %}',
            type: 'POST',
            data: formData,
            processData: false,  // Important: tells jQuery not to process the data
            contentType: false,  // Important: tells jQuery not to set contentType
            success: function(response) {
                console.log('Business UI details updated successfully');
                // Keep the last saved values
                originalImage = $('#headerImagePreview').attr('src');
                originalVisibility = $('#is_visible').is(':checked');
            },
            error: function(xhr, status, error) {
                console.error('Error updating event details:', error);
            }
        });
    }

    $('.event-toggle').change(function() {
        var checked = $(this).is(':checked');
        var eventId = $(this).data('event-id');  // Assuming you add a data-event-id attribute to your inputs
        var label = $(this).next('.toggle-label');
        label.text(checked ? 'Turn Off' : 'Turn On');

        // Post the change to the server
        $.ajax({
            url: '/update-event-status/',  // URL to your Django view
            type: 'POST',
            data: {
                'event_id': eventId,
                'active': checked,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Update successful');
            },
            error: function(xhr, status, error) {
                console.error('Error updating event status:', error);
            }
        });
    });

    $('#confirmDeleteBusiness').click(function() {
      $.ajax({
        url: '{% url "delete_business" business.id %}',
        type: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function() {
          alert('Business deleted successfully!');
          window.location.href = '{% url "dashboard" %}'; 
        },
        error: function(xhr) {
          var errorMessage = 'Failed to delete the business. Contact system admins or try again later';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            alert(errorMessage); 
        }
      });
    });

    function makeHoursEditable($row) {
        var weekday = $row.find('.weekday').text().trim();
        var fromHour = $row.find('.from-hour').text().trim();
        var toHour = $row.find('.to-hour').text().trim();

        // Store original values
        $row.data('original', {weekday: weekday, fromHour: fromHour, toHour: toHour});

        weekday_control_html = '<select class="form-control">'
        for (i = 0; i < available_week_days.length; i++){
            selected = ''
            if (available_week_days[i]["label"] == weekday){
                selected = 'selected'
            }
            weekday_control_html += '<option ' + selected + ' value="' + available_week_days[i]["id"] + '">' + available_week_days[i]["label"] + '</option>'
        }           

        $row.find('.weekday').html(weekday_control_html);
        $row.find('.from-hour').html('<input type="time" class="form-control" value="' + fromHour + '">');
        $row.find('.to-hour').html('<input type="time" class="form-control" value="' + toHour + '">');

        // Show Save and Cancel buttons
        $row.find('.edit-actions').removeClass('d-none');
        $row.find('.dropdown').addClass('d-none');
    }

    // Edit business hour
    $(document).on('click', '.edit-hour', function() {
        var $row = $(this).closest('.hour-entry');
        makeHoursEditable($row);
    });

    // Cancel edit
    $(document).on('click', '.cancel-hour-edit', function() {
        var $row = $(this).closest('.hour-entry');
        var original = $row.data('original');

        // Restore original values
        $row.find('.weekday').html('<span>' + original.weekday + '</span>');
        $row.find('.from-hour').html('<span>' + original.fromHour + '</span>');
        $row.find('.to-hour').html('<span>' + original.toHour + '</span>');

        // Hide Save and Cancel buttons, show dropdown
        $row.find('.edit-actions').addClass('d-none');
        $row.find('.dropdown').removeClass('d-none');
    });

    // Commit edit
    $(document).on('click', '.commit-hour-edit', function() {
        var $row = $(this).closest('.hour-entry');
        var hourId = $row.data('hour-id');
        var url = $row.data('url');
        var weekday = $row.find('.weekday select').val();
        var fromHour = $row.find('.from-hour input').val();
        var toHour = $row.find('.to-hour input').val();

        console.log('hourId: ' + hourId )
        console.log('weekday: ' + weekday )
        console.log('fromHour: ' + fromHour )
        console.log('toHour: ' + toHour )

        // Post to server
        $.post(url, {
            weekday: weekday,
            from_hour: fromHour,
            to_hour: toHour,
            account_id: {{business.id}},
            csrfmiddlewaretoken: '{{ csrf_token }}',
        }, function(response) {
            if(response.success) {
                // Update the display
                weekday_label = weekday
                for (i = 0; i < available_week_days.length; i++){
                    if (available_week_days[i]["id"] == weekday){
                        weekday_label = available_week_days[i]["label"]
                    }
                }     
                $row.find('.weekday').html('<span>' + weekday_label + '</span>');
                $row.find('.from-hour').html('<span>' + fromHour + '</span>');
                $row.find('.to-hour').html('<span>' + toHour + '</span>');

                // Hide Save and Cancel buttons, show dropdown
                $row.find('.edit-actions').addClass('d-none');
                $row.find('.dropdown').removeClass('d-none');
            } else {
                alert("Error updating the business hour.");
            }
        });
    });

    // Add new business hour
    $("#addHourButton").click(function() {
        $("#addHourForm").removeClass('d-none');
        $(this).addClass('d-none');
    });

    // Cancel new hour
    $("#cancelNewHour").click(function() {
        $("#addHourForm").addClass('d-none');
        $("#addHourButton").removeClass('d-none');
        // Reset form values
        $("#newWeekday").val('');
        $("#newFromHour").val('');
        $("#newToHour").val('');
    });

    $("#commitNewHour").click(function() {
        var newDate = $("#newWeekday").val();
        var newFromHour = $("#newFromHour").val();
        var newToHour = $("#newToHour").val();

        // Post the new hours to the server
        $.post("{% url 'business_hour_create' business.id %}", {
            weekday: newDate,
            from_hour: newFromHour,
            to_hour: newToHour,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            // Add any other required data
        }, function(response) {
            if(response.success) {
                var weekdayText = $("#newWeekday option:selected").text();
                var newHourHtml = `
                <div class="table-row hour-entry" data-hour-id="${response.hour_id}" data-url="/${deleteHourBaseUrl}{{business.id}}/${response['hour_id']}">
                    <span class="weekday">${weekdayText}</span>
                    <span class="from-hour">${newFromHour}</span>
                    <span class="to-hour">${newToHour}</span>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item delete-hour" href="#">Delete</a></li>
                            <li><a class="dropdown-item edit-hour" href="#">Edit</a></li>
                        </ul>
                    </div>
                    <div class="edit-actions d-none">
                        <button class="btn btn-success commit-hour-edit">Save</button>
                        <button class="btn btn-danger cancel-hour-edit">Cancel</button>
                    </div>
                </div>`;
                
                // Append the new entry to the business hours list
                $("#addHourButton").before(newHourHtml);
                
                // Reset the form and hide it
                $("#addHourForm").addClass('d-none');
                $("#addHourButton").removeClass('d-none');
                $("#newWeekday").val('');
                $("#newFromHour").val('');
                $("#newToHour").val('');
            } else {
                // Handle errors, such as displaying a message to the user
                alert("Error saving the new special day.");
            }
        });
    });

    // Event handler for Delete hour action
    $(document).on('click', '.delete-hour', function(e) {
        e.preventDefault(); // Prevent default action of the anchor tag

        var $row = $(this).closest('.hour-entry'); // Get the closest hour entry row
        var hourId = $row.data('hour-id'); // Assume each hour entry has a data-hour-id attribute
        var url = $row.data('url');
        console.log('hourId: ' + hourId)

        // Show confirmation dialog
        var confirmDelete = confirm("Are you sure you want to delete this business hour?");
        if (confirmDelete) {
            // User confirmed deletion
            $.ajax({
                url: url,
                method: 'DELETE', // Specifying the method as DELETE
                data: {
                    account_id: {{business.id}}
                    // Include any other necessary data
                },
                headers: {
                    'X-CSRFToken': '{{csrf_token}}' // Include the CSRF token in the request header
                },
                success: function(response) {
                    if (response.success) {
                        // Successfully deleted on the server, now remove the row
                        $row.remove();
                        alert("Business hour deleted successfully.");
                    } else {
                        // Handle failure
                        alert("Error: Could not delete the business hour.");
                    }
                },
                error: function() {
                    // Handle AJAX failure
                    alert("Error communicating with the server.");
                }
            });
        } 
        else {
            // User canceled deletion
            console.log("Deletion canceled.");
        }
    });

    $("#addSpecialDayButton").click(function() {
        $(this).addClass('d-none'); // Hide "Add New" button
        $("#addSpecialDayForm").removeClass('d-none'); // Show inputs and buttons
    });

    $("#cancelNewSpecialDay").click(function() {
        $("#addSpecialDayForm").addClass('d-none'); // Hide form
        $("#addSpecialDayButton").removeClass('d-none'); // Show "Add New" button
        // Reset inputs
        $("#newDate").val('');
        $("#newDateFromHour").val('');
        $("#newDateToHour").val('');
    });

    $("#commitNewSpecialDay").click(function() {
        var newDate = $("#newDate").val();
        var newDateFromHour = $("#newDateFromHour").val();
        var newDateToHour = $("#newDateToHour").val();

        // Post the new hours to the server
        $.post('{% url "special_day_create" business.id %}', {
            date: newDate,
            from_hour: newDateFromHour,
            to_hour: newDateToHour,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response)  {
            if(response.success) {
                // Dynamically create and insert the new special day entry above the "Add New" button
                var newSpecialDayHtml = `<div class="table-row special-day-entry" data-day-id="${response.id}">
                    <span class="date">${newDate}</span>
                    <span class="from-hour">${newDateFromHour}</span>
                    <span class="to-hour">${newDateToHour}</span>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item delete-day" href="#">Delete</a></li>
                            <li><a class="dropdown-item edit-day" href="#">Edit</a></li>
                        </ul>
                    </div>
                    <div class="edit-actions d-none">
                        <button class="btn btn-success commit-edit">Save</button>
                        <button class="btn btn-danger cancel-edit">Cancel</button>
                    </div>
                </div>`;

                // Insert the new entry above the "Add New" button
                $("#addSpecialDayButton").before(newSpecialDayHtml);

                // Hide the form and reset form inputs
                $("#addSpecialDayForm").addClass('d-none');
                $("#addSpecialDayButton").removeClass('d-none');
                $("#newDate").val('');
                $("#newDateFromHour").val('');
                $("#newDateToHour").val('');
            } else {
                // Handle errors, such as displaying a message to the user
                alert("Error saving the new special day.");
            }
        }).fail(function() {
            alert("Error communicating with the server.");
        })
    });

    // Function to make a day entry editable
    function makeEditable($row) {
        var currentDate = $row.find('.date').text().trim();
        var currentFromHour = $row.find('.from-hour').text().trim();
        var currentToHour = $row.find('.to-hour').text().trim();

        $row.data('original-date', currentDate);
        $row.data('original-from-hour', currentFromHour);
        $row.data('original-to-hour', currentToHour);

        $row.find('.date').html(`<input type="date" value="${currentDate}" class="form-control">`);
        $row.find('.from-hour').html(`<input type="time" value="${currentFromHour}" class="form-control">`);
        $row.find('.to-hour').html(`<input type="time" value="${currentToHour}" class="form-control">`);
        $row.find('.edit-actions').removeClass('d-none');
        $row.find('.dropdown').addClass('d-none');
    }

    // Delete Action
    $(".delete-day").click(function(e) {
        e.preventDefault();
        var $row = $(this).closest('.special-day-entry');
        var dayId = $row.data('day-id');
        var url = $row.data('url');

        // Show confirmation dialog
        var confirmDelete = confirm("Are you sure you want to delete this day with special hours?");
        if (confirmDelete) {
            // User confirmed deletion
            $.ajax({
                url: url,
                method: 'DELETE', 
                data: {
                    account_id: {{business.id}}
                },
                headers: {
                    'X-CSRFToken': '{{csrf_token}}' // Include the CSRF token in the request header
                },
                success: function(response) {
                    if (response.success) {
                        // Successfully deleted on the server, now remove the row
                        $row.remove();
                        alert("Business hour deleted successfully.");
                    } else {
                        // Handle failure
                        alert("Error: Could not delete the business hour.");
                    }
                },
                error: function() {
                    // Handle AJAX failure
                    alert("Error communicating with the server.");
                }
            });
        } 
        else {
            // User canceled deletion
            console.log("Deletion canceled.");
        }
    });

    // Edit Action
    $(".edit-day").click(function(e) {
        e.preventDefault();
        var $row = $(this).closest('.special-day-entry');
        makeEditable($row);
    });

    // Confirm Edit Action
    $(".commit-edit").click(function() {
        var $row = $(this).closest('.special-day-entry');
        var url = $row.data('url');
        var newDate = $row.find('input[type="date"]').val();
        var newFromHour = $row.find('input[type="time"]').first().val();
        var newToHour = $row.find('input[type="time"]').last().val();
        var dayId = $row.data('day-id');
        
        // Placeholder for update endpoint
        $.post(url, {
            date: newDate, 
            from_hour: newFromHour, 
            to_hour: newToHour,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if(response.success) {
                $row.find('.date').text(newDate);
                $row.find('.from-hour').text(newFromHour);
                $row.find('.to-hour').text(newToHour);
                $row.find('.edit-actions').addClass('d-none');
                $row.find('.dropdown').removeClass('d-none');
            } else {
                alert("Error updating the special day.");
            }
        });
    });

    $(".cancel-edit").click(function() {
        var $row = $(this).closest('.special-day-entry');
        // Retrieve the original text values stored in the jQuery data
        var originalDate = $row.data('original-date');
        var originalFromHour = $row.data('original-from-hour');
        var originalToHour = $row.data('original-to-hour');

        // Update the HTML of the date, from-hour, and to-hour spans to show the original text
        $row.find('.date').html(`<span>${originalDate}</span>`);
        $row.find('.from-hour').html(`<span>${originalFromHour}</span>`);
        $row.find('.to-hour').html(`<span>${originalToHour}</span>`);

        // Hide the edit actions (save and cancel buttons) and show the dropdown again
        $row.find('.edit-actions').addClass('d-none');
        $row.find('.dropdown').removeClass('d-none');
    });

    $('#inviteWorkerForm').submit(function(e) {
        e.preventDefault();  // Prevent the default form submission behavior

        // Collecting the form data
        var recipientEmail = $('#recipientEmail').val();
        var recipientName = $('#recipientName').val();
        var invitationNotes = $('#invitationNotes').val();
        showSpinner()
        $.ajax({
            url: '{% url "send_business_invitation" %}',
            type: 'POST',
            data: {
                recipient_email: recipientEmail,
                recipient_name: recipientName,
                notes: invitationNotes,
                business_id: '{{ business.id }}',
            },
            headers: {
                'X-CSRFToken': '{{csrf_token}}' 
            },
            success: function(response) {
                // Handle the successful response
                hideSpinner();
                alert(response['message']);
                $('#inviteWorkerModal').modal('hide');
            },
            error: function() {
                // Handle any error
                hideSpinner();
                alert('Error sending invitation');
            },
            complete: function() {
                hideSpinner();  
            }
        });
    });

});    
</script>

{% endblock extra_script %}